const e=Object.prototype.hasOwnProperty;function t(e){return Array.isArray(e)}function n(e){return !!e&&"object"==typeof e&&!t(e)}function o(e){return "function"==typeof e}function i(e){const t=typeof e;return void 0!==e&&"object"!==t&&"function"!==t}function r(e){return "boolean"==typeof e}function s(e){return e instanceof Promise}function l(n){if(!n)return !1;if(t(n))return 0===n.length;for(const t in n)if(e.call(n,t))return !1;return !0}const c=new Set(["boolean","string","number"]);function u(e){return !!e.parent}let a=0;const f=[],d={current:void 0,inRender:!1};function p(e,t){if(a){const n=d.current;if(n){n.nodes||(n.nodes=new Map);const o=n.nodes.get(e);o?(o.track=o.track||t,o.num++):n.nodes.set(e,{node:e,track:t,num:1});}}}const v=Symbol.toPrimitive,h=Symbol("getNode"),g=Symbol("delete"),y=Symbol("opaque"),m=Symbol("optimized"),k=new Map,w=new Map;function b(e){var t;const n=e.root;null===(t=n.activate)||void 0===t||t.call(n),n.computedChildrenNeedingActivation&&(n.computedChildrenNeedingActivation.forEach(b),delete n.computedChildrenNeedingActivation);}function C(e){return e&&e[h]}function A(e,t){return p(e,t),O(e)}function O(e){return b(e),S(e)}function N(e,t){var i;const r=null!==(i=e.parent)&&void 0!==i?i:e,s=e.parent?e.key:"_",l=t===g;l&&(t=void 0);const c=e.parent?M(r):r.root,u=c[s],a=o(t);t=!r.isAssigning&&a?t(u):n(t)&&(null==t?void 0:t[h])?t.peek():t;try{r.isSetting=(r.isSetting||0)+1,l?delete c[s]:c[s]=t;}finally{r.isSetting--;}return r.root.locked&&r.root.set&&r.root.set(r.root._),{prevValue:u,newValue:t}}const P=[];function S(e){let t=0,n=e;for(;u(n);)P[t++]=n.key,n=n.parent;let o=e.root._;for(let e=t-1;o&&e>=0;e--){const t=P[e];o="size"!==t&&(o instanceof Map||o instanceof WeakMap)?o.get(t):o[t];}return o}function _(e,t){var n;let o=null===(n=e.children)||void 0===n?void 0:n.get(t);return o||(o={root:e.root,parent:e,key:t},e.children||(e.children=new Map),e.children.set(t,o)),o}function M(e){let t=S(e);if(!t)if(u(e)){t=M(e.parent)[e.key]={};}else t=e.root._={};return t}function R(e,t,n,o){e.functions||(e.functions=new Map),e.functions.set(t,n),o&&(o.computedChildOfNode=_(e,t),e.root.computedChildrenNeedingActivation||(e.root.computedChildrenNeedingActivation=[]),e.root.computedChildrenNeedingActivation.push(o));}function j(e,t){for(const n in e){const o=e[n];if("function"==typeof o)R(t,n,o);else if("object"==typeof o&&null!=o){const i=C(o);(null==i?void 0:i.isComputed)?(R(t,n,o,i),delete e[n]):o[y]||j(e[n],_(t,n));}}}let I,z=0,T=!1,E=!1,x=[],F=new Map;function H(){F.size>0&&G(!0);}function L(e,t){return function(){return function(e,t){let n=e?JSON.parse(JSON.stringify(e)):{};for(let e=0;e<t.length;e++){const{path:o,prevAtPath:i}=t[e];let r=n;if(o.length>0){let e;for(e=0;e<o.length-1;e++)r=r[o[e]];r[o[e]]=i;}else n=i;}return n}(e,t)}}function V(e,t,n,o,i){const r=new Map;D(r,e,t,[],[],t,n,!0,o,i),J(r,!0);const s=F.get(e);s?s.value=t:F.set(e,{value:t,prev:n,level:o,whenOptimizedOnlyIf:i}),z<=0&&K();}function W(e,t,n,o,i,r,s,l,c,u){if(l?t.listenersImmediate:t.listeners){const l={path:o,pathTypes:i,valueAtPath:r,prevAtPath:s},a=e.get(t);if(a&&o.length>0){const{changes:e}=a;(function(e,t){for(let n=0;n<e.length;n++)if(e[n]!==t[n])return !1;return !0})(e[0].path,l.path)||e.push(l);}else e.set(t,{level:c,value:n,whenOptimizedOnlyIf:u,changes:[l]});}}function D(e,n,o,i,r,s,l,c,u,a){if(W(e,n,o,i,r,s,l,c,u,a),n.linkedFromNodes)for(const t of n.linkedFromNodes)W(e,t,o,i,r,s,l,c,u,a);if(n.parent){const f=n.parent;if(f){D(e,f,S(f),[n.key].concat(i),[t(o)?"array":"object"].concat(r),s,l,c,u+1,a);}}}function J(e,t){const n=new Set;e.forEach((({changes:e,level:o,value:i,whenOptimizedOnlyIf:r},s)=>{const l=t?s.listenersImmediate:s.listeners;if(l){let t;const s=Array.from(l);for(let l=0;l<s.length;l++){const c=s[l],{track:u,noArgs:a,listener:f}=c;if(!n.has(f)){(!0===u||"shallow"===u?o<=0:u!==m||r&&o<=0)&&(a||t||(t={value:i,getPrevious:L(i,e),changes:e}),u||n.add(f),f(t));}}}}));}function K(){const e=F;F=new Map;const t=new Map;e.forEach((({value:e,prev:n,level:o,whenOptimizedOnlyIf:i},r)=>{D(t,r,e,[],[],e,n,!1,o,i);})),J(t,!1);}function q(e,t){t&&x.push(t),B();try{e();}finally{G();}}function B(){z++,I||(I=setTimeout(H,0));}function G(e){if(z--,z<=0||e)if(T)E=!0;else {I&&(clearTimeout(I),I=void 0),z=0;const e=x;e.length&&(x=[]),T=!0,K(),T=!1;for(let t=0;t<e.length;t++)e[t]();E&&(E=!1,G(!0));}}function Q(e,t,n={}){const{initial:o,immediate:i,noArgs:r}=n;let{trackingType:s}=n;"optimize"===s&&(s=m);let l=i?e.listenersImmediate:e.listeners;l||(l=new Set,i?e.listenersImmediate=l:e.listeners=l),b(e);const c={listener:t,track:s,noArgs:r};l.add(c);let u=e.parent;for(;u&&!u.descendantHasListener;)u.descendantHasListener=!0,u=u.parent;if(o){const n=S(e);t({value:n,changes:[{path:[],pathTypes:[],prevAtPath:n,valueAtPath:n}],getPrevious:()=>{}});}return ()=>l.delete(c)}const U=new Set(["copyWithin","fill","from","pop","push","reverse","shift","sort","splice","unshift"]),X=new Set(["every","filter","find","findIndex","forEach","includes","join","map","some"]),Y=new Set(["filter","find"]),Z=new Map,$=new Map([["get",A],["set",oe],["peek",O],["onChange",Q],["assign",function(e,t){const n=te(e);B(),i(e.root._)&&(e.root._={});e.isAssigning=(e.isAssigning||0)+1;try{Object.assign(n,t);}finally{e.isAssigning--;}return G(),n}],["delete",function(e,t){void 0===t&&u(e)&&(t=e.key,e=e.parent);ie(e,null!=t?t:"_",g,-1);}],["toggle",function(e){const t=S(e);if(void 0===t||r(t))return oe(e,!t),!t}]]);function ee(e,r,s){if(n(r)&&r[y]||n(s)&&s[y]){const t=r!==s;return t&&(e.listeners||e.listenersImmediate)&&V(e,r,s,0),t}const l=t(r);let c,u;const a=r instanceof Map,f=r?a?Array.from(r.keys()):Object.keys(r):[],d=s?a?Array.from(s.keys()):Object.keys(s):[];let p,v,h,g=!1;if(l&&t(s)){if(s.length>0){const t=s[0];if(void 0!==t&&(p=function(e,t){let i=n(e)?"id"in e?"id":"key"in e?"key":"_id"in e?"_id":"__id"in e?"__id":void 0:void 0;if(!i&&t.parent){const e=S(t.parent)[t.key+"_keyExtractor"];e&&o(e)&&(i=e);}return i}(t,e),p&&(v=o(p),c=new Map,u=[],e.children)))for(let t=0;t<s.length;t++){const n=s[t];if(n){const o=e.children.get(t+"");if(o){const e=v?p(n):n[p];c.set(e,o);}}}}}else if(s&&(!r||n(r))){const t=d.length;for(let n=0;n<t;n++){const t=d[n];if(!f.includes(t)){g=!0;const n=_(e,t),o=a?s.get(t):s[t];void 0!==o&&(i(o)||ee(n,void 0,o),(n.listeners||n.listenersImmediate)&&V(n,void 0,o,0));}}}if(r&&!i(r)){const t=f.length;g=g||(null==f?void 0:f.length)!==(null==d?void 0:d.length);const n=g;let o=!1;if(e.descendantHasListener||!g){for(let d=0;d<t;d++){const t=f[d],h=a?r.get(t):r[t],y=a?null==s?void 0:s.get(t):null==s?void 0:s[t];let m=h!==y;if(m){const r=p&&h?v?p(h):h[p]:void 0;let a=_(e,t);if(l&&void 0!==r){const i=void 0!==r?null==c?void 0:c.get(r):void 0;if(i){if(void 0!==i&&i.key!==t){const r=s[i.key];n&&(a=i,e.children.delete(a.key),a.key=t,u.push([t,a])),o=!0,m=r!==h;}}else m=!1,g=!0;}if(m)if(i(h))g=!0;else {const e=(!g||!!a.descendantHasListener)&&ee(a,h,y);g=g||e;}!m&&n||(a.listeners||a.listenersImmediate)&&V(a,h,y,0,!n);}}if(u)for(let t=0;t<u.length;t++){const[n,o]=u[t];e.children.set(n,o);}}h=g||o;}else void 0!==s&&(h=!0);return null!=h&&h}function te(e,t){return void 0!==t&&(e=_(e,t)),e.proxy||(e.proxy=new Proxy(e,ne))}const ne={get(e,r,s){var l;if(r===v)throw new Error("[legend-state] observable is not a primitive.");if(r===h)return e;if(e.linkedToNode&&"onChange"!==r)return ne.get(e.linkedToNode,r,s);const c=O(e);if(c instanceof Map||c instanceof WeakMap||c instanceof Set||c instanceof WeakSet){const t=function(e,t,n){const i=null==n?void 0:n[t];if("size"===t)return te(e,t);if(o(i))return function(o,i,r){const s=arguments.length,l=n;if("get"===t){if(s>0&&"boolean"!=typeof o&&o!==m)return te(e,o)}else if("set"===t){if(2===s){const t=l.get(o),n=l.set(o,i);return t!==i&&re(_(e,o),i,t),n}}else if("delete"===t){if(s>0){const t=n.get?l.get(o):o,i=n.delete(o);return i&&re(_(e,o),void 0,t),i}}else {if("clear"===t){const t=new Map(l),o=l.size;return l.clear(),void(o&&re(e,n,t))}if("add"===t){const i=new Set(n),r=n.add(o);return n.has(t)||V(e,r,i,0),r}}const c=$.get(t);if(!c)return n[t](o,i);switch(s){case 0:return c(e);case 1:return c(e,o);case 2:return c(e,o,i);default:return c(e,o,i,r)}}}(e,r,c);if(void 0!==t)return t}const a=$.get(r);if(a)return function(t,n,o){switch(arguments.length){case 0:return a(e);case 1:return a(e,t);case 2:return a(e,t,n);default:return a(e,t,n,o)}};if(e.isComputed){if(e.proxyFn&&!a)return e.proxyFn(r);b(e);}const f=Z.get(r);if(f)return f.get(e);const d=i(c);if((null==c||d)&&w.size&&(e.isActivatedPrimitive||k.has(r))){e.isActivatedPrimitive=!0;const t=w.get(r);if(void 0!==t)return o(t)?t(te(e)):t}const g=null==c?void 0:c[r];if(n(c)&&c[y])return g;if(o(g)){if(t(c)){if(U.has(r))return (...n)=>function(e,n,o,...i){var r;const s=t(n)&&n.slice()||n,l=n[o].apply(n,i);if(e){const t=u(e),o=t?e.key:"_";(t?S(e.parent):e.root)[o]=s,ie(null!==(r=e.parent)&&void 0!==r?r:e,o,n);}return l}(e,c,r,...n);if(X.has(r))return p(e),function(t,n){function o(n,o,i){return t(te(e,o+""),o,i)}if(Y.has(r)){const t="find"===r,n=[];for(let i=0;i<c.length;i++)if(o(c[i],i,c)){const o=te(e,i+"");if(t)return o;n.push(o);}return t?void 0:n}return c[r](o,n)}}return g.bind(c)}if(i(g)&&t(c)&&"length"===r)return p(e,!0),g;const C=null===(l=e.functions)||void 0===l?void 0:l.get(r);return C||te(e,r)},getPrototypeOf(e){const t=S(e);return null!==t&&"object"==typeof t?Reflect.getPrototypeOf(t):null},ownKeys(e){const n=S(e);if(i(n))return [];const o=n?Reflect.ownKeys(n):[];return p(e,!0),t(n)&&"length"===o[o.length-1]&&o.splice(o.length-1,1),o},getOwnPropertyDescriptor(e,t){const n=S(e);return i(n)?void 0:Reflect.getOwnPropertyDescriptor(n,t)},set(e,t,n){if(e.isSetting)return Reflect.set(e,t,n);if(e.isAssigning)return ie(e,t,n),!0;const o=Z.get(t);return !!o&&(o.set(e,n),!0)},deleteProperty:(e,t)=>!!e.isSetting&&Reflect.deleteProperty(e,t),has(e,t){const n=S(e);return Reflect.has(n,t)}};function oe(e,t){if(!s(t))return e.parent?ie(e.parent,e.key,t):ie(e,"_",t);t.then((t=>oe(e,t))).catch((t=>oe(e,{error:t})));}function ie(e,t,n,r){if(e.root.locked&&!e.root.set)throw new Error("[legend-state] Modified locked observable");const s=!e.parent&&"_"===t,l=s?e:_(e,t),{newValue:c,prevValue:u}=N(l,n),a=o(n),f=i(c)||c instanceof Date;return c!==u&&re(e,c,u,l,f,s,r),a?c:s?te(e):te(e,t)}function re(e,n,o,r,s,c,u){r||(r=e),B();let a=s,f=!1;(!s||o&&!i(o))&&(a=ee(r,n,o),t(n)&&(f=(null==n?void 0:n.length)!==(null==o?void 0:o.length))),(s||!n||l(n)&&!l(o)?n!==o:a)&&V(s&&c?e:r,n,o,(null!=u?u:void 0===o)?-1:a?0:1,f),G();}function se(e){return e&&!!e[h]}function le(e,t,n){let i=e;return o(i)&&(i=t?i(t):i()),se(i)&&!n?i.get():i}function ce(e,t){var n;const o=null===(n=C(e))||void 0===n?void 0:n.root;o&&(o.locked=t);}const ue=["get","set","peek","onChange","toggle"];function ae(e){this._node=e;for(let e=0;e<ue.length;e++){const t=ue[e];this[t]=this[t].bind(this);}}function fe(e,t){ae.prototype[e]=function(...e){return t.call(this,this._node,...e)};}function de(e,t){const n=s(e),o={root:{_:n?void 0:e}},i=t||(r=e,c.has(typeof r));var r;const l=i?new ae(o):te(o);return n?(e.catch((e=>{l.set({error:e});})),e.then((e=>{l.set(e);}))):i||e&&j(e,o),l}function pe(e){return de(e)}function ve(e,t,n,o){let i=[];return null==e||e.forEach((e=>{const{node:r,track:s}=e;i.push(Q(r,t,{trackingType:s,immediate:o,noArgs:n}));})),()=>{if(i){for(let e=0;e<i.length;e++)i[e]();i=void 0;}}}function he(e,t,n,o,i,r){let s,l,c,u,p,v=t;return se(e)?(l=e.peek(),c=e.onChange(t),p=i?e.onChange(t):void 0):(!function(e){f.push(d.current),a++,d.inRender=e,d.current={};}(r),l=e?le(e,n,null==o?void 0:o.retainObservable):e,u=d.current,s=u.nodes,a--,a<0&&(a=0),r&&(d.inRender=!1),d.current=f.pop()),(null==n?void 0:n.cancel)||(c=ve(s,v,!1,null==o?void 0:o.immediate),p=i?()=>ve(s,v):void 0),{value:l,dispose:c,resubscribe:p}}function ge(e,t,n){let i,r;o(t)?i=t:n=t;let s=!0;const l={num:0},c=function(){l.onCleanup&&(l.onCleanup(),l.onCleanup=void 0),B(),delete l.value,null==r||r();const{dispose:t,value:o}=he(e,c,l,n);var u,a;r=t,l.value=o,l.onCleanupReaction&&(l.onCleanupReaction(),l.onCleanupReaction=void 0),!i||!(l.num>0)&&((u=e)&&(null===(a=u[h])||void 0===a?void 0:a.isEvent))||!s&&l.previous===l.value||i(l),l.previous=l.value,l.num++,G(),s=!1;};return c(),()=>{var e,t;null===(e=l.onCleanup)||void 0===e||e.call(l),l.onCleanup=void 0,null===(t=l.onCleanupReaction)||void 0===t||t.call(l),l.onCleanupReaction=void 0,null==r||r();}}function ye(e,t){const n=pe();ce(n,!0);const o=C(n);o.isComputed=!0;let i=!1;const r=function(e){const t=o.linkedToNode;t&&(t.linkedFromNodes.delete(o),o.linkedToNode=void 0);const r=o.computedChildOfNode;if(se(e)){const n=C(e);if(o.linkedToNode=n,n.linkedFromNodes||(n.linkedFromNodes=new Set),n.linkedFromNodes.add(o),o.computedChildOfNode&&Q(n,(({value:e})=>{N(o.computedChildOfNode,e);}),{initial:!0}),t){const e=S(n),i=S(t);V(o,e,i,0);}}else if(e!==n.peek()){ce(n,!1);const t=i?oe:N;if(t(o,e),r){let n=!1;r.root.locked&&(r.root.locked=!1,n=!0),t(r,e),n&&(r.root.locked=!0);}ce(n,!0);}else r&&N(r,e);i=!0;};return o.root.activate=()=>{o.root.activate=void 0,ge(e,(({value:e})=>{s(e)?e.then((e=>r(e))):r(e);}),{immediate:!0,retainObservable:!0});},t&&(o.root.set=e=>{q((()=>t(e)));}),n}function me(e,o,i){let r;if(ge((function(s){const c=le(e);(i?function(e){return !(!e||(n(e)||t(e))&&l(e))}(c):c)&&(r=c,null==o||o(c),s.cancel=!0);})),void 0!==r)return Promise.resolve(r);{const e=new Promise((e=>{if(o){const t=o;o=n=>{const o=t(n);e(o);};}else o=e;}));return e}}function ke(e,t){return me(e,t,!1)}fe("peek",O),fe("get",A),fe("set",oe),fe("onChange",Q),Object.defineProperty(ae.prototype,h,{configurable:!0,get(){return this._node}}),ae.prototype.toggle=function(){const e=this.peek();return (void 0===e||r(e))&&this.set(!e),!e},ae.prototype.delete=function(){return this.set(void 0),this};

export { le as a, se as b, d, he as h, i, ke as k, l, o, pe as p, q, s, t, ye as y };
