(()=>{"use strict";var e={2565:(e,r,t)=>{var n=t(3298),o=/[\/\?<>\\:\*\|"]/g,a=/[\x00-\x1f\x80-\x9f]/g,s=/^\.+$/,i=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,c=/[\. ]+$/;function u(e,r){if("string"!=typeof e)throw new Error("Input must be string");var t=e.replace(o,r).replace(a,r).replace(s,r).replace(i,r).replace(c,r);return n(t,255)}e.exports=function(e,r){var t=r&&r.replacement||"",n=u(e,t);return""===t?n:u(n,"")}},3298:(e,r,t)=>{var n=t(2815),o=t(2875);e.exports=n.bind(null,o)},2815:e=>{function r(e){return e>=55296&&e<=56319}function t(e){return e>=56320&&e<=57343}e.exports=function(e,n,o){if("string"!=typeof n)throw new Error("Input must be string");for(var a,s,i=n.length,c=0,u=0;u<i;u+=1){if(a=n.charCodeAt(u),s=n[u],r(a)&&t(n.charCodeAt(u+1))&&(s+=n[u+=1]),(c+=e(s))===o)return n.slice(0,u+1);if(c>o)return n.slice(0,u-s.length+1)}return n}},2875:e=>{function r(e){return e>=55296&&e<=56319}function t(e){return e>=56320&&e<=57343}e.exports=function(e){if("string"!=typeof e)throw new Error("Input must be string");for(var n=e.length,o=0,a=null,s=null,i=0;i<n;i++)t(a=e.charCodeAt(i))?null!=s&&r(s)?o+=1:o+=3:a<=127?o+=1:a>=128&&a<=2047?o+=2:a>=2048&&a<=65535&&(o+=3),s=a;return o}}},r={};function t(n){var o=r[n];if(void 0!==o)return o.exports;var a=r[n]={exports:{}};return e[n](a,a.exports,t),a.exports}t.m=e,t.u=e=>e+".js",t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var r=t.g.document;if(!e&&r&&(r.currentScript&&(e=r.currentScript.src),!e)){var n=r.getElementsByTagName("script");if(n.length)for(var o=n.length-1;o>-1&&!e;)e=n[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})(),t.b=document.baseURI||self.location.href,(()=>{function e(e){let r="";const t=new Uint8Array(e),n=t.byteLength;for(let e=0;e<n;++e)r+=String.fromCharCode(t[e]);return window.btoa(r)}var r,n,o,a,s,i,c;t(2565),function(e){e[e.forward=0]="forward",e[e.backward=1]="backward"}(r||(r={})),(c=n||(n={}))[c.drmProtected=1]="drmProtected",c[c.fileLinkLost=2]="fileLinkLost",function(e){e[e.none=0]="none",e[e.showAnkiDialog=1]="showAnkiDialog",e[e.updateLastCard=2]="updateLastCard",e[e.exportCard=3]="exportCard"}(o||(o={})),function(e){e[e.remember=0]="remember",e[e.play=1]="play",e[e.pause=2]="pause"}(a||(a={})),function(e){e[e.atStart=1]="atStart",e[e.atEnd=2]="atEnd"}(s||(s={})),function(e){e[e.normal=1]="normal",e[e.condensed=2]="condensed",e[e.autoPause=3]="autoPause",e[e.fastForward=4]="fastForward",e[e.repeat=5]="repeat"}(i||(i={}));class u{static async encode(e,r){return new Promise((async(t,n)=>{var o=new FileReader;o.onload=async e=>{try{const o=new AudioContext;if(null===e.target)return void n(new Error("Could not obtain buffer to encode"));const a=await o.decodeAudioData(e.target.result),s=[];for(let e=0;e<a.numberOfChannels;++e)s.push(a.getChannelData(e));const i=r(),c=i instanceof Worker?i:await i;c.postMessage({command:"encode",audioBuffer:{channels:s,numberOfChannels:a.numberOfChannels,length:a.length,sampleRate:a.sampleRate}}),c.onmessage=e=>{t(new Blob(e.data.buffer,{type:"audio/mp3"})),c.terminate()},c.onerror=e=>{const r=e?.error??new Error("MP3 encoding failed: "+e?.message);n(r),c.terminate()}}catch(e){n(e)}},o.readAsArrayBuffer(e)}))}}const d=new class{constructor(){this.recording=!1,this.recorder=null,this.stream=null,this.blobPromise=null}startWithTimeout(e,r,t){return new Promise((async(n,o)=>{try{if(this.recording)return console.error("Already recording, cannot start with timeout."),void o("Already recording");await this.start(e),t(),setTimeout((async()=>{n(await this.stop())}),r)}catch(e){o(e)}}))}start(e){return new Promise(((r,t)=>{if(this.recording)t("Already recording, cannot start");else try{const t=new MediaRecorder(e),n=[];t.ondataavailable=e=>{n.push(e.data)},this.blobPromise=new Promise(((e,r)=>{t.onstop=r=>{e(new Blob(n))}})),t.start();const o=new AudioContext;o.createMediaStreamSource(e).connect(o.destination),this.recorder=t,this.recording=!0,this.stream=e,r(void 0)}catch(e){t(e)}}))}async stop(){if(!this.recording)throw new Error("Not recording, unable to stop");this.recording=!1,this.recorder?.stop(),this.recorder=null,this.stream?.getTracks()?.forEach((e=>e.stop())),this.stream=null;const r=await this.blobPromise;return this.blobPromise=null,await e(await r.arrayBuffer())}},l=async(r,n)=>{if(n){const n=await(await fetch("data:audio/webm;base64,"+r)).blob(),o=await u.encode(n,(()=>new Worker(new URL(t.p+t.u(265),t.b))));r=e(await o.arrayBuffer())}const o={sender:"asbplayer-offscreen-document",message:{command:"audio-base64",base64:r}};chrome.runtime.sendMessage(o)},f=e=>navigator.mediaDevices.getUserMedia({audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}}});window.onload=async()=>{const e=(e,r,t)=>{if("asbplayer-extension-to-offscreen-document"===e.sender)switch(e.message.command){case"start-recording-audio-with-timeout":const r=e.message;return f(r.streamId).then((e=>d.startWithTimeout(e,r.timeout,(()=>t(!0))))).then((e=>l(e,r.preferMp3))).catch((e=>{console.error(e instanceof Error?e.message:String(e)),t(!1)})),!0;case"start-recording-audio":const n=e.message;return f(n.streamId).then((e=>d.start(e))).then((()=>t(!0))).catch((e=>{console.error(e),t(!1)})),!0;case"stop-recording-audio":const o=e.message;d.stop().then((e=>l(e,o.preferMp3)))}};chrome.runtime.onMessage.addListener(e),window.addEventListener("beforeunload",(r=>{chrome.runtime.onMessage.removeListener(e)}))}})()})();